sap.ui.define(["jquery.sap.global","sap/ui/core/mvc/Controller","sap/ui/model/json/JSONModel","nrg/module/quickpay/view/QuickPayControl","nrg/base/type/Price","sap/ui/model/Filter","sap/ui/model/FilterOperator"],function(a,b,c,d,e,f,g){"use strict";var h=b.extend("nrg.module.billing.view.CustomerDataBillingInfo");return h.prototype.onInit=function(){},h.prototype.onBeforeRendering=function(){this.getOwnerComponent().getCcuxApp().setTitle("BILLING"),this.getView().setModel(this.getOwnerComponent().getModel("comp-billing"),"oDataSvc"),this.getView().setModel(this.getOwnerComponent().getModel("comp-billing-invoice"),"oDataInvoiceSvc"),this.getView().setModel(this.getOwnerComponent().getModel("comp-eligibility"),"oDataEligSvc"),this.getView().setModel(new sap.ui.model.json.JSONModel,"oEligibility"),this.getView().setModel(new sap.ui.model.json.JSONModel,"oBillingInvoices"),this.getView().setModel(new sap.ui.model.json.JSONModel,"oPmtSummary"),this.getView().setModel(new sap.ui.model.json.JSONModel,"oPmtPayments"),this.getView().setModel(new sap.ui.model.json.JSONModel,"oPmtItems"),this.getView().setModel(new sap.ui.model.json.JSONModel,"oInvoiceSelectInfo"),this.getView().setModel(new sap.ui.model.json.JSONModel,"oInvoiceSelectFilters"),this.getView().setModel(new sap.ui.model.json.JSONModel,"oInvoiceSelectDateRange"),this._initRoutingInfo(),this._initRetrBillInvoices(),this._initBillingMsgs(),this._retreInvoiceNotification(),$(document).on("keydown",function(a){8!==a.which||$(a.target).is("input, textarea")||a.preventDefault()})},h.prototype.onAfterRendering=function(){this.getOwnerComponent().getCcuxApp().setLayout("FullWidthTool"),this.getOwnerComponent().getCcuxApp().showNavLeft(!0),this.getOwnerComponent().getCcuxApp().detachNavRightAll(),this.getOwnerComponent().getCcuxApp().attachNavLeft(this._navLeftCallBack,this),this.getOwnerComponent().getCcuxApp().updateFooter(this._bpNum,this._caNum,this._coNum)},b.prototype._navLeftCallBack=function(){var a=this.getOwnerComponent().getRouter();this._coNum&&this._caNum&&this._bpNum?a.navTo("dashboard.VerificationWithCaCo",{bpNum:this._bpNum,caNum:this._caNum,coNum:this._coNum}):!this._coNum&&this._caNum&&this._bpNum?a.navTo("dashboard.VerificationWithCa",{bpNum:this._bpNum,caNum:this._caNum}):this._coNum||this._caNum||!this._bpNum||a.navTo("dashboard.Verification",{bpNum:this._bpNum})},h.prototype._initBillingMsgs=function(){var a,b,c,d,e,f=this.getView().byId("idnrgBillingMsgs"),g=this.getView().byId("idnrgBillingMsgsTemp"),h=this.getView().byId("idnrgBilDunMsgs"),i=this.getView().byId("idnrgBilDunMsgsTemp"),j="/AlertsSet",k=function(){};a=["BP","CA","Identifier"],b=[this._bpNum,this._caNum,"BILLING"],c=this._createSearchFilterObject(a,b),d={model:"comp-billing",path:j,template:g,filters:c,events:{dataReceived:k}},f.bindAggregation("content",d),a=["BP","CA","Identifier"],b=[this._bpNum,this._caNum,"DUNNING"],c=this._createSearchFilterObject(a,b),e={model:"comp-billing",path:j,template:i,filters:c,events:{dataReceived:k}},h.bindAggregation("content",e)},b.prototype._createSearchFilterObject=function(a,b){var c,d=[];for(c=0;c<a.length;c+=1)d.push(new f(a[c],g.EQ,b[c],""));return d},h.prototype.onExit=function(){},h.prototype._initRoutingInfo=function(){var a=this.getOwnerComponent().getCcuxRouteManager().getCurrentRouteInfo();this._bpNum=a.parameters.bpNum,this._caNum=a.parameters.caNum,this._coNum=a.parameters.coNum},h.prototype._initRetrBillInvoices=function(){var a,b,c=this.getView().getModel("oDataSvc");a="/BillInvoices('"+this._caNum+"')",b={success:function(a){a&&(this.getView().getModel("oBillingInvoices").setData(a),this._curInvNum=a.InvoiceNum,this._initRetrInvoiceDetail(this._curInvNum))}.bind(this),error:function(){}.bind(this)},c&&c.read(a,b)},h.prototype._initRetrInvoiceDetail=function(a){this._retrInvSumry(a),this._retrInvPmts(a),this._retrInvItems(a)},h.prototype._retrInvSumry=function(a){var b,c,d=this.getView().getModel("oDataSvc");b="/PaymentHdrs('"+a+"')/PaymentSumry",c={success:function(a){a&&this.getView().getModel("oPmtSummary").setData(a.results[0])}.bind(this),error:function(){}.bind(this)},d&&d.read(b,c)},h.prototype._retrInvPmts=function(a){var b,c,d=this.getView().getModel("oDataSvc");b="/PaymentHdrs('"+a+"')/Payments",c={success:function(a){a&&this.getView().getModel("oPmtPayments").setData(a)}.bind(this),error:function(){}.bind(this)},d&&d.read(b,c)},h.prototype._retrInvItems=function(a){var b,c,d=this.getView().getModel("oDataSvc");b="/PaymentHdrs('"+a+"')/PaymentItems",c={success:function(a){a&&this.getView().getModel("oPmtItems").setData(a)}.bind(this),error:function(){}.bind(this)},d&&d.read(b,c)},h.prototype._formatDate=function(a){var b;return a?b=(a.getMonth()+1).toString()+"/"+a.getDate().toString()+"/"+a.getFullYear().toString():null},h.prototype._formatBoolCurChrg=function(a){return"X"===a||"x"===a?!0:!1},h.prototype._formatBoolCurChrg_Rev=function(a){return"X"===a||"x"===a?!1:!0},h.prototype._onInvoiceAmntClicked=function(){var a=this.getOwnerComponent().getModel("comp-i18n-billing"),b=a.getProperty("nrgBilling-paymentsPopup-ACCOUNT_SUMMARY");this._oInvoicePopup||(this._oInvoicePopup=sap.ui.xmlfragment("PaymentPopup","nrg.module.billing.view.InvoicePopup",this),this._oInvoicePopup=ute.ui.main.Popup.create({content:this._oInvoicePopup,title:b}),this._oInvoicePopup.setShowCloseButton(!0),this.getView().addDependent(this._oInvoicePopup)),this._oInvoicePopup.open(),this._curInvNum&&this._initRetrInvoiceDetail(this._curInvNum)},h.prototype._onPaymentsClicked=function(){var a=this.getOwnerComponent().getModel("comp-i18n-billing"),b=a.getProperty("nrgBilling-paymentsPopup-PAYMENTS");this._oPaymentPopup||(this._oPaymentPopup=sap.ui.xmlfragment("PaymentPopup","nrg.module.billing.view.PaymentsPopup",this),this._oPaymentsPopup=ute.ui.main.Popup.create({content:this._oPaymentPopup,title:b}),this._oPaymentsPopup.setShowCloseButton(!0),this.getView().addDependent(this._oPaymentsPopup)),this._oPaymentsPopup.open()},h.prototype.onPayNow=function(){var a=new d;this._sContract=this._coNum,this._sBP=this._bpNum,this._sCA=this._caNum,this.getView().addDependent(a),a.openQuickPay(this._sContract,this._sBP,this._sCA)},h.prototype._onChkbookLnkClicked=function(){var a=this.getOwnerComponent().getRouter();this._coNum?a.navTo("billing.CheckBook",{bpNum:this._bpNum,caNum:this._caNum,coNum:this._coNum}):a.navTo("billing.CheckBookNoCo",{bpNum:this._bpNum,caNum:this._caNum})},h.prototype._onHighbillLnkClicked=function(){var a=this.getOwnerComponent().getRouter();this._coNum?a.navTo("billing.HighBill",{bpNum:this._bpNum,caNum:this._caNum,coNum:this._coNum}):a.navTo("billing.HighBillNoCo",{bpNum:this._bpNum,caNum:this._caNum})},h.prototype._onInvoiceNumClicked=function(){var a=this.getView().getModel("oBillingInvoices");a.oData.InvUrl&&window.open(a.oData.InvUrl,"_blank")},h.prototype._retreInvoiceNotification=function(){var a,b="/EligCheckS('"+this._coNum+"')",c=this.getView().getModel("oDataEligSvc"),d=this.getView().getModel("oEligibility");a={success:function(a){d.setData(a)}.bind(this),error:function(){}.bind(this)},c&&c.read(b,a)},h.prototype._onInvoiceSelectClicked=function(){var a,b,c=!1;this.getOwnerComponent().getCcuxApp().setOccupied(!0),this._oInvSelectPopup||(this._oInvSelectPopup=ute.ui.main.Popup.create({content:sap.ui.xmlfragment(this.getView().sId,"nrg.module.billing.view.InvSelectPopup",this),title:"INVOICE SELECTION"}),this._oInvSelectPopup.addStyleClass("nrgBilling-invSelectPopup"),this.getView().addDependent(this._oInvSelectPopup),this.getView().byId("nrgBilling-invSel-stDate").attachBrowserEvent("select",this._handleStartDateChange,this),this.getView().byId("nrgBilling-invSel-edDate").attachBrowserEvent("select",this._handleEndDateChange,this),a=new Date,a.setMonth(a.getMonth()-18),this.getView().byId("nrgBilling-invSel-stDate").setMinDate(a),this.getView().byId("nrgBilling-invSel-edDate").setMinDate(a)),this._oInvSelectPopup.open(),this._retrieveInvoiceInfo(this._caNum,function(){c=!0}),b=setInterval(function(){c&&(this.getOwnerComponent().getCcuxApp().setOccupied(!1),this._initializeFilters(),this._initializeDateRange(),clearInterval(b))}.bind(this),100)},h.prototype._retrieveInvoiceInfo=function(a,b){var c,d,e,h,i,j="/InvoiceS",k=[],l=this.getView().getModel("oDataInvoiceSvc"),m=this.getView().getModel("oInvoiceSelectInfo");k.push(new f({path:"ContAccount",operator:g.EQ,value1:a})),c={filters:k,success:function(a){if(a.results){for(m.setData(a.results),e=this.getView().byId("nrgBilling-invSelPopup-tableBody"),d=e.getContent().length,h=0;d>h;h+=1)e.removeContent(0);for(i=0;i<m.oData.length;i+=1){m.oData[i].View=!1;var c=new ute.ui.commons.Tag({elem:"div"}).addStyleClass("nrgBilling-invSelPopup-tableRow");(i+1)%2===0&&c.addStyleClass("nrgBilling-invSelPopup-tableRow-even"),c.addContent(new ute.ui.commons.Tag({elem:"div",text:m.oData[i].Date}).addStyleClass("nrgBilling-invSelPopup-tableRow-item").addStyleClass("date")),c.addContent(new ute.ui.commons.Tag({elem:"div",text:m.oData[i].PrintDoc}).addStyleClass("nrgBilling-invSelPopup-tableRow-item").addStyleClass("number")),c.addContent(new ute.ui.commons.Tag({elem:"div",text:m.oData[i].DataType}).addStyleClass("nrgBilling-invSelPopup-tableRow-item").addStyleClass("description")),c.addContent(new ute.ui.main.Checkbox({checked:m.oData[i].View}).addStyleClass("nrgBilling-invSelPopup-tableRow-item").addStyleClass("view")),e.addContent(c)}b&&b()}}.bind(this),error:function(){}.bind(this)},l&&l.read(j,c)},h.prototype._initializeFilters=function(){var a=this.getView().getModel("oInvoiceSelectFilters");a.setProperty("/All",!0),this._onSelectAll(),a.setProperty("/Disconnect",!1),a.setProperty("/Invoice",!1),a.setProperty("/Reversal",!1)},h.prototype._initializeDateRange=function(){var a,b,c=this.getView().getModel("oInvoiceSelectDateRange"),d=new Date,e=new Date;a=this._formatInvoiceDate(d.getDate(),d.getMonth()+1,d.getFullYear()),e.setMonth(e.getMonth()-12),b=this._formatInvoiceDate(e.getDate(),e.getMonth()+1,e.getFullYear()),this.getView().byId("nrgBilling-invSel-stDate").setDefaultDate(b),this.getView().byId("nrgBilling-invSel-edDate").setDefaultDate(a),c.setProperty("/Start",b),c.setProperty("/End",a),this._filterByDateRange()},h.prototype._formatInvoiceDate=function(a,b,c){return 10>a&&(a="0"+a),10>b&&(b="0"+b),b+"/"+a+"/"+c},h.prototype._deformatInvoiceDate=function(a){var b=a.split("/");return new Date(b[2],b[0]-1,b[1])},h.prototype._filterByDateRange=function(){var a,b,c,d=this.getView().byId("nrgBilling-invSelPopup-tableBody"),e=this.getView().getModel("oInvoiceSelectDateRange"),f=this.getView().getModel("oInvoiceSelectFilters");for(a=0;a<d.getContent().length;a+=1)b=d.getContent()[a].getContent()[0].getText(),d.getContent()[a].setVisible(this._deformatInvoiceDate(b)<this._deformatInvoiceDate(e.oData.Start)||this._deformatInvoiceDate(b)>this._deformatInvoiceDate(e.oData.End)?!1:!0);for(c in f.oData)"All"!==c&&f.setProperty("/"+c,!1)},h.prototype._handleStartDateChange=function(){var a=this.getView().getModel("oInvoiceSelectDateRange"),b=this.getView().byId("nrgBilling-invSel-stDate").getValue();a.setProperty("/Start",b),this._filterByDateRange()},h.prototype._handleEndDateChange=function(){var a=this.getView().getModel("oInvoiceSelectDateRange"),b=this.getView().byId("nrgBilling-invSel-edDate").getValue();a.setProperty("/End",b),this._filterByDateRange()},h.prototype._onSelectAll=function(){var a,b,c=this.getView().byId("nrgBilling-invSelPopup-tableBody"),d=this.getView().getModel("oInvoiceSelectFilters");for(a=0;a<c.getContent().length;a+=1)b=c.getContent()[a].getContent()[3],b.setChecked(d.oData.All)},h.prototype._onSelectDisconnect=function(){this._applyTypeFilter("Disconnect")},h.prototype._onSelectInvoice=function(){this._applyTypeFilter("Invoice")},h.prototype._onSelectReversed=function(){this._applyTypeFilter("Reversal")},h.prototype._applyTypeFilter=function(a){var b,c,d,e,f,g=this.getView().byId("nrgBilling-invSelPopup-tableBody"),h=this.getView().getModel("oInvoiceSelectFilters"),i=this.getView().getModel("oInvoiceSelectDateRange");for(d=0;d<g.getContent().length;d+=1)e=g.getContent()[d].getContent()[0].getText(),b=!1,c=!1,g.getContent()[d].getContent()[2].getText()!==a&&h.oData[a]||(b=!0),this._deformatInvoiceDate(e)>=this._deformatInvoiceDate(i.oData.Start)&&this._deformatInvoiceDate(e)<=this._deformatInvoiceDate(i.oData.End)&&(c=!0),g.getContent()[d].setVisible(b&&c?!0:!1);for(f in h.oData)"All"!==f&&f!==a&&h.setProperty("/"+f,!1)},h.prototype._onOpenBtnClick=function(){var a,b,c=this.getView().byId("nrgBilling-invSelPopup-tableBody"),d=this.getView().getModel("oInvoiceSelectInfo");for(a=0;a<c.getContent().length;a+=1)b=c.getContent()[a].getContent()[3],b.getChecked()&&c.getContent()[a].getVisible()&&this._openNewWindowDelayed(d.oData[a].URL)},h.prototype._openNewWindowDelayed=function(a){setTimeout(function(){window.open(a,"_blank")},1e3)},b.prototype.onMessages=function(a){var b,c,d,e,f,g=this;this.getOwnerComponent().getCcuxApp().setOccupied(!0),this._oDialogFragment||(this._oDialogFragment=sap.ui.xmlfragment("DunnlingLocks","nrg.module.billing.view.DunningPopup",this)),void 0===this._oDunningDialog&&(this._oDunningDialog=new ute.ui.main.Popup.create({title:"Dunning",content:this._oDialogFragment})),b=a.getSource().getBindingContext("comp-billing").getPath()+"/DunningLocksSet",d=sap.ui.core.Fragment.byId("DunnlingLocks","idnrgBillDn-Table"),e=sap.ui.core.Fragment.byId("DunnlingLocks","idnrgBillDn-Row"),f=function(){g.getOwnerComponent().getCcuxApp().setOccupied(!1)},c={model:"comp-billing",path:b,template:e,events:{dataReceived:f}},this.getView().addDependent(this._oDunningDialog),this._oDunningDialog.addStyleClass("nrgCamHis-dialog"),d.bindRows(c),this._oDunningDialog.open()},h});