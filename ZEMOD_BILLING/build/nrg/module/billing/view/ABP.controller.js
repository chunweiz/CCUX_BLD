sap.ui.define(["nrg/base/view/BaseController","sap/ui/model/Filter","sap/ui/model/FilterOperator","jquery.sap.global","sap/ui/model/json/JSONModel","nrg/module/billing/view/control/AverageBillDetailsChart"],function(a,b,c,d,e,f){"use strict";var g=a.extend("nrg.module.billing.view.ABP");return g.prototype.onInit=function(){},g.prototype.onBeforeRendering=function(){},g.prototype.onAfterRendering=function(){this._OwnerComponent=this.getView().getParent().getParent().getParent().getController().getOwnerComponent(),this._ABPPopupControl=this.getView().getParent(),this._aYearList=[],this._aGraphClors=["blue","gray","yellow"],this.getView().setModel(this._OwnerComponent.getModel("comp-billing-avgplan"),"oDataAvgSvc"),this.getView().setModel(new sap.ui.model.json.JSONModel,"oEligibility"),this.getView().setModel(new sap.ui.model.json.JSONModel,"oUsageGraph"),this.getView().setModel(new sap.ui.model.json.JSONModel,"oAmountBtn"),this.getView().setModel(new sap.ui.model.json.JSONModel,"oAmountHistory");var a=this._OwnerComponent.getCcuxRouteManager().getCurrentRouteInfo();this._bpNum=a.parameters.bpNum,this._caNum=a.parameters.caNum,this._coNum=a.parameters.coNum,this._initialCheck()},g.prototype._retrieveTableInfo=function(a,d){var e,f,g,h,i,j="/AvgAddS",k=[],l=this.getView().getModel("oDataAvgSvc"),m=this.getView().getModel("oAmountHistory"),n=[];k.push(new b({path:"Contract",operator:c.EQ,value1:a})),f={filters:k,success:function(a){if(a.results){for(g=0;g<a.results.length;g+=1)"Total"!==a.results[g].Period?(h={},i=a.results[g].Period,h=a.results[g],h.Period=h.Period.substr(0,2)+"/"+h.Period.substr(6,4),h.FullPeriod=i,h.ActualBill="$"+parseFloat(h.ActualBill),h.Usage=parseFloat(h.Usage),h.AdjAmount=parseFloat(h.Adjsmnt),h.AmtUsdAbp=parseFloat(h.AmtUsdAbp),n.push(h)):e=parseFloat(a.results[g].AmtUsdAbp);m.setData(n),m.setProperty("/totalAmount",e),m.setProperty("/estAmount","$"+parseFloat(a.results[0].Estimate).toFixed(2)),d&&d()}}.bind(this),error:function(){}.bind(this)},l&&l.read(j,f)},g.prototype._retrieveGraphInfo=function(a,d){var e,f,g,h="/AvgUsgS",i=[],j=this.getView().getModel("oDataAvgSvc"),k=this.getView().getModel("oUsageGraph"),l=[];i.push(new b({path:"Contract",operator:c.EQ,value1:a})),e={filters:i,success:function(a){if(a.results){for(f=0;f<a.results.length;f+=1)g={},g.usageDate=a.results[f].Period,g.usage=parseInt(a.results[f].Consumption,10),l.push(g);k.setProperty("/data",l),d&&d()}}.bind(this),error:function(){}.bind(this)},j&&j.read(h,e)},g.prototype._retrieveABPEligibility=function(a,b){var c,d="/EligibilityS('"+a+"')",e=this.getView().getModel("oDataAvgSvc"),f=this.getView().getModel("oEligibility");c={success:function(a){f.setData(a),"Y"===a.ABPAct?(f.setProperty("/Activated",!0),f.setProperty("/NonActivated",!1)):(f.setProperty("/Activated",!1),f.setProperty("/NonActivated",!0)),b&&b()}.bind(this),error:function(){f.setProperty("/ABPElig","N"),b&&b()}.bind(this)},e&&e.read(d,c)},g.prototype._initialCheck=function(){var a,b,c,e=this.getView().getModel("oEligibility"),g=this._OwnerComponent.getCcuxWebUiManager(),h=!1,i=!1,j=!1;this._coNum?(this._retrieveABPEligibility(this._coNum,function(){j=!0}),b=setInterval(function(){var k,l;if(j){if(this._OwnerComponent.getCcuxApp().setOccupied(!0),"Y"===e.oData.ABPElig)if("Y"===e.oData.ABPAct)"X"===e.oData.NoBillHistory||"x"===e.oData.NoBillHistory?ute.ui.main.Popup.Confirm({title:"No Billing History",message:"Customer has no billing history to display. Do you wish to deactivate Average Billing Plan?",callback:function(a){"Yes"===a&&g.notifyWebUi("openIndex",{LINK_ID:"Z_AVGBIL_D"})}}):g.notifyWebUi("openIndex",{LINK_ID:"Z_AVGBIL_D"}),this._OwnerComponent.getCcuxApp().setOccupied(!1),clearTimeout(c),this._ABPPopupControl.close();else{for(this._retrieveTableInfo(this._coNum,function(){h=!0}),this._retrieveGraphInfo(this._coNum,function(){i=!0}),k=0;k<this.getView().byId("nrgBilling-avgBillingPopup-usage-control").getContent().length;k++)l=this.getView().byId("nrgBilling-avgBillingPopup-usage-control").getContent()[k],l.getContent()[0].setChecked(!0);a=setInterval(function(){if(h&&i){if(this._OwnerComponent.getCcuxApp().setOccupied(!1),clearInterval(a),clearTimeout(c),!this.graphControl){var b=this.getView().byId("nrgBilling-avgBillingPopup-usage-graph");this.graphControl=new f("chart",{width:700,height:250,usageTickSize:200}),this.graphControl.placeAt(b),this._ABPPopupControl.$().offset({top:(d(window).height()-this._ABPPopupControl.getDomRef().offsetHeight-250)/2})}this.graphControl.setDataModel(this.getView().getModel("oUsageGraph")),this._renderGraphCrontrolBtn()}}.bind(this),100)}else ute.ui.main.Popup.Alert({title:"Not Eligible",message:"You are not eligible for Average Billing Plan."}),this._OwnerComponent.getCcuxApp().setOccupied(!1),clearTimeout(c),this._ABPPopupControl.close();clearInterval(b)}}.bind(this),100),c=setTimeout(function(){ute.ui.main.Popup.Alert({title:"Network service failed",message:"We cannot retrieve your data. Please try again later."}),clearInterval(a),this._OwnerComponent.getCcuxApp().setOccupied(!1)}.bind(this),3e4)):(ute.ui.main.Popup.Alert({title:"Contract Not Found",message:"Contract number is not found in the routing."}),this._ABPPopupControl.close())},g.prototype._onCancelBtnClick=function(){this._ABPPopupControl.close()},g.prototype._onCalBtnClick=function(){var a,b,c,d,e,f=this.getView().getModel("oDataAvgSvc"),g=this.getView().getModel("oAmountHistory"),h={};for(h.Contract=this._coNum,b=0;b<g.oData.length;b+=1)c="Prd"+this._pad(b+1),d="Bbs"+this._pad(b+1),e="Amt"+this._pad(b+1),h[c]=g.oData[b].FullPeriod,h[d]=g.oData[b].Basis,h[e]=(parseFloat(g.oData[b].AdjAmount)||0).toString();f&&(a={method:"POST",urlParameters:h,success:function(a){"S"===a.Code?g.setProperty("/estAmount","$"+parseFloat(a.Message)):ute.ui.main.Popup.Alert({title:"Request failed",message:a.Message})}.bind(this),error:function(){ute.ui.main.Popup.Alert({title:"Request failed",message:"The request cannot be sent due to the network or the oData service."})}.bind(this)},f.callFunction("/ABPCalc",a))},g.prototype._onSetBtnClick=function(){var a,b=this.getView().getModel("oDataAvgSvc"),c=this.getView().getModel("oAmountHistory");b&&(a={method:"POST",urlParameters:{Contract:this._coNum,Date:c.oData[c.oData.length-1].FullPeriod,IsRetro:this.isRetro},success:function(a){"S"===a.Code?(this._ABPPopupControl.close(),ute.ui.main.Popup.Alert({title:"Success",message:"ABP activation success and contact log has been created."}),this._retrieveABPEligibility(this._coNum)):ute.ui.main.Popup.Alert({title:"Request failed",message:a.Message})}.bind(this),error:function(){ute.ui.main.Popup.Alert({title:"Request failed",message:"The request cannot be sent due to the network or the oData service."})}.bind(this)},b.callFunction("/ABPCrte",a))},g.prototype._onDeactBtnClick=function(){{var a,b=this.getView().getModel("oDataAvgSvc");this.getView().getModel("oAmountHistory")}b&&(a={method:"POST",urlParameters:{Contract:this._coNum},success:function(a){"S"===a.Code?(this._ABPPopupControl.close(),ute.ui.main.Popup.Alert({title:"Success",message:"You have canceled the ABP successfully."}),this._retrieveABPEligibility(this._coNum)):ute.ui.main.Popup.Alert({title:"Request failed",message:a.Message})}.bind(this),error:function(){ute.ui.main.Popup.Alert({title:"Request failed",message:"The request cannot be sent due to the network or the oData service."})}.bind(this)},b.callFunction("/ABPCanc",a))},g.prototype.onSelected=function(a){var b=a.getSource(),c=this._aYearList[parseInt(b.getId().replace(this.getView().getId()+"--nrgBilling-avgBillingPopup-graphControlChkbox-",""),10)].toString(),d=b.getChecked(),e=this.graphControl;e&&e.hideUsage(c,!d)},g.prototype._renderGraphCrontrolBtn=function(){var a,b,c,d=this.getView().getModel("oUsageGraph");if(d.oData.data.length)for(a=0;a<d.oData.data.length;a+=1)c=d.oData.data[a].usageDate.split("/"),this._aYearList.indexOf(c[2])<0&&this._aYearList.push(c[2]);for(b=0;b<this._aYearList.length;b+=1)this.getView().byId("nrgBilling-avgBillingPopup-graphControlBtn-"+b).setVisible(!0),this.getView().byId("nrgBilling-avgBillingPopup-graphControlText-"+b).setText(this._aYearList[b]).addStyleClass("usageChartLegend-label-"+this._aGraphClors[b])},g.prototype._pad=function(a){return 10>a?"0"+a.toString():a.toString()},g.prototype.onPopupClose=function(){this.getView().getParent().close()},g});