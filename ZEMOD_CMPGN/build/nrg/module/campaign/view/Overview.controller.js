sap.ui.define(["nrg/base/view/BaseController","sap/ui/model/Filter","sap/ui/model/FilterOperator","jquery.sap.global","sap/ui/model/json/JSONModel"],function(a,b,c,d,e){"use strict";var f=a.extend("nrg.module.campaign.view.Overview");return f.prototype.onInit=function(){this._aPendingSelPaths=[]},f.prototype.onAfterRendering=function(){this.getOwnerComponent().getCcuxApp().updateFooter(this._sBP,this._sCA,this._sContract)},f.prototype.onBeforeRendering=function(){var a,b,c,f,g,h,i,j,k,l,m,n,o,p,q,r=this.getOwnerComponent().getModel("comp-campaign"),s=this.getView().byId("idnrgCamOvr-TabBar"),t=this.getView().byId("idnrgCamOvr-TabItem").clone(),u=this,v=[],w=this.getOwnerComponent().getCcuxRouteManager().getCurrentRouteInfo();q=this.getOwnerComponent().getModel("comp-i18n-campaign"),this.getOwnerComponent().getCcuxApp().setTitle("CAMPAIGNS"),this.getOwnerComponent().getCcuxApp().setOccupied(!0),this._sContract=w.parameters.coNum,this._sBP=w.parameters.bpNum,this._sCA=w.parameters.caNum,this._sFlag=w.parameters.typeV.toUpperCase(),h=["Contract"],i=[this._sContract],g=this._createSearchFilterObject(h,i),a=q.getProperty("nrgCurrentPendingSet"),b="/ButtonS",b=b+"('"+this._sContract+"')",n=new e,j=function(){var a,b=s.getBinding("content");if(f=s.getContent(),void 0!==f&&f.length>0){if(u._sFlag&&("PE"===u._sFlag||"P"===u._sFlag))for(u._sFlag="PE",p=0;p<f.length;p+=1)k=f[p].getBindingContext("comp-campaign").getProperty("Type"),a=f[p].getBindingContext("comp-campaign").getProperty("OfferCode"),k&&k===u._sFlag&&"00000000"!==k?(f[p].setSelected(!0),l=f[p].getBindingContext("comp-campaign").getPath()):k||"C"===k||(f[p].setEnabled(!1),u._sFlag="C",ute.ui.main.Popup.Alert({title:"Information",message:"Pending Campaign is not available"}));if(u._sFlag&&"C"===u._sFlag)for(p=0;p<f.length;p+=1)k=f[p].getBindingContext("comp-campaign").getProperty("Type"),k&&k===u._sFlag?(f[p].setSelected(!0),l=f[p].getBindingContext("comp-campaign").getPath()):k&&"PE"!==k||f[p].setEnabled(!1);if(o=this.getModel("comp-campaign").getProperty(l+"/EFLs"),o&&o.length>0){for(p=0;p<o.length;p+=1)v.push(this.getModel("comp-campaign").getProperty("/"+o[p]));n.setData(u.convertEFLJson(v)),u._oEFLModel=n,m=sap.ui.view({preprocessors:{xml:{models:{tmpl:u._oEFLModel}}},type:sap.ui.core.mvc.ViewType.XML,viewName:"nrg.module.campaign.view.EFLData"}),u.getView().byId("idnrgCamOvrPriceT").removeAllAggregation("content"),u.getView().byId("idnrgCamOvrPriceT").addContent(m)}u.getView().bindElement({model:"comp-campaign",path:l})}u.getOwnerComponent().getCcuxApp().setOccupied(!1),b&&b.detachDataReceived(j)},c={model:"comp-campaign",path:a,template:t,filters:g,parameters:{expand:"EFLs"},events:{dataReceived:j}},s.bindAggregation("content",c),c={success:function(){this.getView().byId("idCamCustReqOfferBtn").bindElement({model:"comp-campaign",path:b}),r.updateBindings(!1),d.sap.log.info("Odata Read Successfully:::"),u.getOwnerComponent().getCcuxApp().setOccupied(!1)}.bind(this),error:function(){u.getOwnerComponent().getCcuxApp().setOccupied(!1),d.sap.log.info("Eligibility Error occured")}.bind(this)},r&&r.read(b,c)},f.prototype._createSearchFilterObject=function(a,d){var e,f=[];for(e=0;e<a.length;e+=1)f.push(new b(a[e],c.EQ,d[e],""));return f},f.prototype.toggleCampaign=function(a){var b,c,d,f,g,h=[],i=this;if(b=a.getSource().getBindingContext("comp-campaign").getPath(),g=new e,i.getView().byId("idnrgCamOvrPriceT").removeAllAggregation("content"),c=this.getView().getModel("comp-campaign").getProperty(b+"/EFLs"),void 0!==c&&c.length>0)for(d=0;d<c.length;d+=1)h.push(this.getView().getModel("comp-campaign").getProperty("/"+c[d]));g.setData(i.convertEFLJson(h)),f=sap.ui.view({preprocessors:{xml:{models:{tmpl:g}}},type:sap.ui.core.mvc.ViewType.XML,viewName:"nrg.module.campaign.view.EFLData"}),i.getView().byId("idnrgCamOvrPriceT").addContent(f),this.getView().bindElement({model:"comp-campaign",path:b})},f.prototype.onAgentRequestedOffers=function(a){var b=a.getSource().getBindingContext("comp-campaign").getProperty("FirstBill"),c=a.getSource().getBindingContext("comp-campaign").getProperty("InitTab");this._sInitTab=c&&void 0!==c&&null!==c&&""!==c?c:"SE","X"===b?ute.ui.main.Popup.Alert({title:"Information",message:"Customer has to completed atleast One Month Invoice"}):this._getPendingSwapsCount(a)},f.prototype.onCustomerRequestedOffers=function(a){var b=a.getSource().getBindingContext("comp-campaign").getProperty("FirstBill"),c=(a.getSource().getBindingContext("comp-campaign").getProperty("CustEligFlag"),a.getSource().getBindingContext("comp-campaign").getProperty("InitTab")),d=a.getSource().getBindingContext("comp-campaign").getProperty("PendMvo"),e=this.getOwnerComponent().getModel("comp-i18n-campaign");return this._sInitTab=c&&void 0!==c&&null!==c&&""!==c?c:"SE",d?void ute.ui.main.Popup.Alert({title:"Information",message:e.getProperty("nrgCmpOvrPendingMoveOut")}):void(b?this._getPendingSwapsCount(a):ute.ui.main.Popup.Alert({title:"Information",message:e.getProperty("nrgCmpOvrFirstBillMsg")}))},f.prototype._getPendingSwapsCount=function(){var a,b,c,e,f,g,h=this,i=this.getOwnerComponent().getModel("comp-i18n-campaign");a=i.getProperty("nrgPendingSwapsSet"),a+="/$count",b=["Contract"],c=[this._sContract],e=this._createSearchFilterObject(b,c),f={filters:e,success:function(a){a&&(d.sap.log.info("Odata Read Successfully:::"),parseInt(a,10)>0?h.showPendingSwaps():h.navTo("campaignoffers",{bpNum:h._sBP,caNum:h._sCA,coNum:h._sContract,typeV:h._sInitTab}))}.bind(this),error:function(a){d.sap.log.info("Odata Failed:::"+a)}.bind(this)},g=this.getOwnerComponent().getModel("comp-campaign"),g&&g.read(a,f)},f.prototype.formatType=function(a){var b=this.getOwnerComponent().getModel("comp-i18n-campaign");return b.getProperty("C"===a?"nrgCmpOvrCt":"nrgCmpOvrPg")},f.prototype.convertEFLJson=function(a){var b,c,d,e,f=[],g=[],h=!1,i=[],j=[];for(c=0;c<a.length;c+=1)if(b=a[c],void 0!==b&&void 0!==b.EFLType&&void 0!==j){for(d=0;d<j.length;d+=1)if(b.EFLType===j[d]){h=!0;break}h?h=!1:j.push(b.EFLType)}for(c=0;c<a.length;c+=1)if(b=a[c],void 0!==b&&void 0!==b.EFLLevel&&void 0!==g){for(d=0;d<g.length;d+=1)if(b.EFLLevel===g[d]){h=!0;break}h?h=!1:(g.push(b.EFLLevel),f.push({EFLLevel:b.EFLLevel}))}for(e={},e.results={},e.results.columns=f,e.results.rows=[],d=0;d<j.length;d+=1){for(i=[],c=0;c<a.length;c+=1)b=a[c],void 0!==b&&void 0!==b.EFLLevel&&void 0!==b.EFLType&&b.EFLType===j[d]&&i.push({EFLPrice:b.EFLPrice});e.results.rows.push({cells:i})}return e},f.prototype.showPendingSwaps=function(){var a,b,c,d,f,g,h,i,j=this.getOwnerComponent().getModel("comp-i18n-campaign"),k=new e({selected:0,ReqNumber:"",ReqName:"",NoPhone:!1}),l=this;this.getView().setModel(k,"localModel"),this.getOwnerComponent().getCcuxApp().setOccupied(!0),f=["Contract"],g=[this._sContract],d=this._createSearchFilterObject(f,g),this._oDialogFragment||(this._oDialogFragment=sap.ui.xmlfragment("PendingOverview","nrg.module.campaign.view.PendingSwaps",this)),void 0===this._oCancelDialog&&(this._oCancelDialog=new ute.ui.main.Popup.create({title:"Change Campaign - Cancel",close:this._handleDialogClosed,content:this._oDialogFragment})),a=j.getProperty("nrgPendingSwapsSet"),c=sap.ui.core.Fragment.byId("PendingOverview","idnrgCamPds-pendTable"),h=sap.ui.core.Fragment.byId("PendingOverview","idnrgCamPds-pendRow"),i=function(){var a=c.getBinding("rows");l._oCancelDialog.open(),l.getOwnerComponent().getCcuxApp().setOccupied(!1),a&&a.detachDataReceived(i)},b={model:"comp-campaign",path:a,filters:d,template:h,events:{dataReceived:i}},c.bindRows(b),this.getView().addDependent(this._oCancelDialog),this._oCancelDialog.addStyleClass("nrgCamHis-dialog")},f.prototype.onAvgUsage=function(){this.navTo("usage",{bpNum:this._sBP,caNum:this._sCA,coNum:this._sContract,typeV:"C"})},f.prototype.onPendingSwapsSelected=function(a){var b,c,d,e=this.getView().getModel("localModel").getProperty("/selected");b=a.getSource().getParent().getBindingContext("comp-campaign").getPath(),c=this._aPendingSelPaths.indexOf(b),a.getSource().getChecked()?(e+=1,d=0>c&&this._aPendingSelPaths.push(b)):(e-=1,d=c>-1&&this._aPendingSelPaths.splice(c,1)),this.getView().getModel("localModel").setProperty("/selected",e)},f.prototype.ProceedwithCancel=function(){var a,b,c,e,f,g=this.getOwnerComponent().getModel("comp-campaign"),h=this.getOwnerComponent().getModel("comp-i18n-campaign");return b=this.getView().getModel("localModel"),c=b.getProperty("/ReqName"),e=b.getProperty("/ReqNumber"),f=b.getProperty("/NoPhone"),this._aPendingSelPaths&&this._aPendingSelPaths.length>0?c&&""!==c?f||e&&""!==e?(g.setRefreshAfterChange(!1),this._aPendingSelPaths.forEach(function(b){var f=g.getContext(b);a={method:"POST",urlParameters:{iDoc:f.getProperty("IdocNo"),ReqNumber:e,Type:f.getProperty("SwapType"),ReqName:c,Contract:f.getProperty("Contract"),Hist:f.getProperty("HistoryNo")},success:function(){d.sap.log.info("Odata Read Successfully:::")}.bind(this),error:function(){d.sap.log.info("Eligibility Error occured")}.bind(this)},g.callFunction("/DeleteCampaign",a)}),this._oCancelDialog.close(),void this.navTo("campaignoffers",{bpNum:this._sBP,caNum:this._sCA,coNum:this._sContract,typeV:this._sInitTab})):void ute.ui.main.Popup.Alert({title:"Information",message:h.getProperty("nrgCmpOvrNoPhoneErrMsg")}):void ute.ui.main.Popup.Alert({title:"Information",message:h.getProperty("nrgCmpOvrEntReqName")}):void ute.ui.main.Popup.Alert({title:"Information",message:h.getProperty("nrgCmpOvrPendingSwapSelection")})},f.prototype.ContinueWithoutCancel=function(){this._oCancelDialog.close(),this.navTo("campaignoffers",{bpNum:this._sBP,caNum:this._sCA,coNum:this._sContract,typeV:this._sInitTab})},f});